--#SET SQLFORMAT SQLPL                                                          
--#SET TERMINATOR ต                                                             
                                                                                
CREATE PROCEDURE DP0GWPRD.ESAN350G                                              
    ( IN    p_PACKAGE       CHAR(6)                                             
    ,IN     p_APPNM         CHAR(8)                                             
    ,IN     p_USERID        CHAR(8)                                             
    ,IN     p_APPLID        CHAR(8)                                             
    ,INOUT  p_TS            CHAR(26)                                            
    ,INOUT  p_ESEVERE       CHAR(1)                                             
    ,INOUT  p_ENUM          INTEGER                                             
    ,INOUT  p_EGROUP        INTEGER                                             
    ,INOUT  p_ESQLCD        INTEGER                                             
    ,INOUT  p_EPGM          CHAR(8)                                             
    ,INOUT  p_ETEXT         CHAR(250)                                           
    ,INOUT  p_EDBAVAIL      CHAR(1)                                             
    ,INOUT  p_POID          DECIMAL(15, 0)                                      
    )                                                                           
    VERSION V1                                                                  
    LANGUAGE SQL                                                                
    NOT DETERMINISTIC                                                           
    MODIFIES SQL DATA                                                           
    CALLED ON NULL INPUT                                                        
    DYNAMIC RESULT SETS 2                                                       
    ALLOW DEBUG MODE                                                            
    ASUTIME LIMIT 500000                                                        
    COMMIT ON RETURN NO                                                         
    WITH EXPLAIN                                                                
    ISOLATION LEVEL CS                                                          
    RELEASE AT COMMIT                                                           
    WITHOUT KEEP DYNAMIC                                                        
    DYNAMICRULES RUN                                                            
    REOPT NONE                                                                  
    VALIDATE BIND                                                               
    SQL PATH DP0GWPRD                                                           
  BEGIN                                                                         
---------------------------------------------------------------------------     
--    THIS MODULE WILL RETURN CURRENT VT_ADVC_RBL_TWS_ST INFORMATION            
--    FOR AN INPUT PO-ID                                                        
---------------------------------------------------------------------------     
--                        MAINTENANCE LOG                                       
--                                                                              
-- PGR   DATE         DESCRIPTION                                               
-- ----  ----------   -----------                                               
-- U2WB  05/15/2014   ORIGINAL                                                  
---------------------------------------------------------------------------     
--        ERR   L                                                               
--        CODES V    DESCRIPTION                                                
---4 -----11 ---17 -21 ----------------------------------------------------     
-- DASMSG 1100  93  NO PACKAGESET PASSED                                        
-- DASMSG 1120  99  UNABLE TO SET PACKAGESET                                    
-- DASMSG 1300  99  UNABLE TO SET TIMESTAMP                                     
-- DASMSG 1400  93  p_POID IS BLANK                                             
-- DASMSG 1500  99  ERROR OPENNING TW_ST_CSR                                    
---------------------------------------------------------------------------     
-- VARIABLE DECLARATION                                                         
---------------------------------------------------------------------------     
   DECLARE v_POID DECIMAL(15,0) DEFAULT 0;                                      
---------------------------------------------------------------------------     
-- REQUIRED FIELDS TO CALL ERROR COBOL SP                                       
---------------------------------------------------------------------------     
   DECLARE v_ERR_LOG_FL  CHAR(1)    DEFAULT ' ';                                
   DECLARE v_ERR_MSG     VARCHAR(400)  DEFAULT ' ';                             
   DECLARE v_SQLSTATE    CHAR(5)    DEFAULT ' ';                                
---------------------------------------------------------------------------     
                                                                                
-- REQUIRED FIELD TO DISPLAY FOR DEBUGGING                                      
---------------------------------------------------------------------------     
   DECLARE v_DISPL_MSG  VARCHAR(930);                                           
   DECLARE v_DEBUG_MODE_FL   CHAR(01) DEFAULT 'N';                              
   DECLARE v_LABEL           CHAR(12) DEFAULT ' ';                              
---------------------------------------------------------------------------     
-- RETURN CODE DECLARATION                                                      
---------------------------------------------------------------------------     
   DECLARE SQLCODE  INTEGER DEFAULT 0;                                          
   DECLARE SQLSTATE CHAR(5) DEFAULT '00000';                                    
   DECLARE RETCODE  INTEGER DEFAULT 0;                                          
---------------------------------------------------------------------------     
--                                                                              
---------------------------------------------------------------------------     
-- THE FOLLOWING CURSOR RETRIEVES CURRENT INFORMATION FROM THE TRADE    .       
-- WORKSHEET STATUS TABLE FOR A PARTICULAR INSTANCE OF REBALANCE                
---------------------------------------------------------------------------     
 DECLARE TW_ST_CSR CURSOR WITH RETURN FOR                                       
      WITH TWS                                                                  
      ( ADVC_PROFL_ID                                                           
       ,SAG_ID                                                                  
       ,TWS_RBLNC_NO                                                            
       ,TWS_CREW_PO_ID                                                          
       ,TWS_STATUS_CD                                                           
       ,VALIDT_PRO_CMPL_FL                                                      
       ,LST_UPDTD_USER_ID                                                       
       ,SYS_BGN_TS                                                              
       ,RPT_INSTNC_ID                                                           
      ) AS                                                                      
      (                                                                         
       SELECT TWS.ADVC_PROFL_ID                                                 
             ,APR.SAG_ID                                                        
             ,TWS.RBLNC_NO AS TWS_RBLNC_NO                                      
             ,TWS.TWS_CREW_PO_ID                                                
             ,TWS.TWS_STATUS_CD                                                 
             ,TWS.VALIDT_PRO_CMPL_FL                                            
             ,TWS.LST_UPDTD_USER_ID                                             
             ,TWS.SYS_BGN_TS                                                    
             ,TWS.RPT_INSTNC_ID                                                 
       FROM VT_ADVC_RBL_TWS_ST TWS                                              
       INNER JOIN VADVC_PROFL  APR                                              
          ON APR.ADVC_PROFL_ID = TWS.ADVC_PROFL_ID                              
       INNER JOIN VSAG_BUS_RLSHP BUS                                            
          ON BUS.SAG_ID = APR.SAG_ID                                            
       INNER JOIN VSAG SAG                                                      
          ON SAG.SAG_ID = BUS.SAG_ID                                            
       WHERE APR.EFFTV_BGN_DT            <= CURRENT DATE                        
         AND APR.EFFTV_END_DT            >  CURRENT DATE                        
         AND SAG.EFFTV_END_DT            > CURRENT DATE                         
         AND SAG.SERV_ID = 413                                                  
         AND BUS.PO_ROLE_CD = 'OW'                                              
         AND BUS.PO_ID = p_POID                                                 
                                                                                
      )                                                                         
      ,                                                                         
      TWS_HIST                                                                  
      ( ADVC_PROFL_ID                                                           
       ,TWS_RBLNC_NO                                                            
       ,TWS_STATUS_CD                                                           
       ,SYS_BGN_TS                                                              
      )                                                                         
       AS                                                                       
      (                                                                         
       SELECT TWH.ADVC_PROFL_ID                                                 
             ,TWH.RBLNC_NO AS TWS_RBLNC_NO                                      
             ,TWH.TWS_STATUS_CD                                                 
             ,TWH.SYS_BGN_TS                                                    
       FROM VT_ADV_RB_TWS_ST_H TWH                                              
       INNER JOIN TWS                                                           
          ON TWS.ADVC_PROFL_ID = TWH.ADVC_PROFL_ID                              
         AND TWS.TWS_RBLNC_NO = TWH.RBLNC_NO                                    
      )                                                                         
      ,                                                                         
      ADD_INFO                                                                  
      (    ADVC_PROFL_ID                                                        
          ,RBL_CUR_RBLNC_NO                                                     
          ,SAG_STATUS_CD                                                        
          ,IMPLM_BGN_DT                                                         
      )                                                                         
       AS                                                                       
      (                                                                         
          SELECT                                                                
                 TWS.ADVC_PROFL_ID                                              
                ,RBL.RBLNC_NO             AS RBL_CUR_RBLNC_NO                   
                ,STS.SAG_STATUS_CD                                              
                ,SAD.IMPLM_BGN_DT                                               
            FROM TWS                                                            
            INNER JOIN VT_ADVC_PROF_RBLNC RBL                                   
               ON TWS.ADVC_PROFL_ID           = RBL.ADVC_PROFL_ID               
            INNER JOIN VSAG_STATUS STS                                          
               ON STS.SAG_ID = TWS.SAG_ID                                       
            INNER JOIN VSAG_ADVC SAD                                            
               ON SAD.SAG_ID = TWS.SAG_ID                                       
            WHERE STS.SAG_STATUS_END_TS       > CURRENT TIMESTAMP               
       )                                                                        
       ,                                                                        
       TWSC                                                                     
       ( ADVC_PROFL_ID                                                          
        ,RBLNC_NO                                                               
        ,SYS_BGN_TS                                                             
       )                                                                        
       AS                                                                       
       ( SELECT                                                                 
           ADVC_PROFL_ID                                                        
          ,TWS_RBLNC_NO AS RBLNC_NO                                             
          ,SYS_BGN_TS                                                           
         FROM TWS                                                               
         WHERE TWS_STATUS_CD = 'TWSC'                                           
         UNION ALL                                                              
         SELECT                                                                 
           ADVC_PROFL_ID                                                        
          ,TWS_RBLNC_NO AS RBLNC_NO                                             
          ,SYS_BGN_TS                                                           
         FROM TWS_HIST                                                          
         WHERE TWS_STATUS_CD = 'TWSC'                                           
         ORDER BY SYS_BGN_TS ASC                                                
         FETCH FIRST ROW ONLY                                                   
       )                                                                        
      ,                                                                         
       TWSI                                                                     
       ( ADVC_PROFL_ID                                                          
        ,RBLNC_NO                                                               
        ,SYS_BGN_TS                                                             
       )                                                                        
       AS                                                                       
       ( SELECT                                                                 
           ADVC_PROFL_ID                                                        
          ,TWS_RBLNC_NO AS RBLNC_NO                                             
          ,SYS_BGN_TS                                                           
         FROM TWS                                                               
         WHERE TWS_STATUS_CD = 'TWSI'                                           
         UNION ALL                                                              
         SELECT                                                                 
           ADVC_PROFL_ID                                                        
          ,TWS_RBLNC_NO AS RBLNC_NO                                             
          ,SYS_BGN_TS                                                           
         FROM TWS_HIST                                                          
         WHERE TWS_STATUS_CD = 'TWSI'                                           
         ORDER BY SYS_BGN_TS ASC                                                
         FETCH FIRST ROW ONLY                                                   
       )                                                                        
       ,                                                                        
       TS                                                                       
       (                                                                        
          ADVC_PROFL_ID                                                         
         ,SYS_BGN_TS                                                            
         ,DAYNAME                                                               
         ,MONTHNAME                                                             
         ,RBLDAY                                                                
         ,RBLTIME                                                               
         ,RBLYEAR                                                               
        ) AS                                                                    
        (    SELECT                                                             
            TWSI.ADVC_PROFL_ID                                                  
           ,COALESCE(TWSC.SYS_BGN_TS,TWSI.SYS_BGN_TS)                           
     ,CASE                                                                      
       WHEN DAYOFWEEK(COALESCE(TWSC.SYS_BGN_TS,TWSI.SYS_BGN_TS)) = 1            
       THEN 'SUN'                                                               
       WHEN DAYOFWEEK(COALESCE(TWSC.SYS_BGN_TS,TWSI.SYS_BGN_TS)) = 2            
       THEN 'Mon'                                                               
       WHEN DAYOFWEEK(COALESCE(TWSC.SYS_BGN_TS,TWSI.SYS_BGN_TS)) = 3            
       THEN 'Tue'                                                               
       WHEN DAYOFWEEK(COALESCE(TWSC.SYS_BGN_TS,TWSI.SYS_BGN_TS)) = 4            
       THEN 'Wed'                                                               
       WHEN DAYOFWEEK(COALESCE(TWSC.SYS_BGN_TS,TWSI.SYS_BGN_TS)) = 5            
       THEN 'Thu'                                                               
       WHEN DAYOFWEEK(COALESCE(TWSC.SYS_BGN_TS,TWSI.SYS_BGN_TS)) = 6            
       THEN 'Fri'                                                               
       WHEN DAYOFWEEK(COALESCE(TWSC.SYS_BGN_TS,TWSI.SYS_BGN_TS)) = 7            
       THEN 'Sat'                                                               
      END                                                                       
     ,CASE                                                                      
       WHEN MONTH(COALESCE(TWSC.SYS_BGN_TS,TWSI.SYS_BGN_TS)) = 1                
       THEN 'Jan'                                                               
       WHEN MONTH(COALESCE(TWSC.SYS_BGN_TS,TWSI.SYS_BGN_TS)) = 2                
       THEN 'Feb'                                                               
       WHEN MONTH(COALESCE(TWSC.SYS_BGN_TS,TWSI.SYS_BGN_TS)) = 3                
       THEN 'Mar'                                                               
       WHEN MONTH(COALESCE(TWSC.SYS_BGN_TS,TWSI.SYS_BGN_TS)) = 4                
       THEN 'Apr'                                                               
       WHEN MONTH(COALESCE(TWSC.SYS_BGN_TS,TWSI.SYS_BGN_TS)) = 5                
       THEN 'May'                                                               
       WHEN MONTH(COALESCE(TWSC.SYS_BGN_TS,TWSI.SYS_BGN_TS)) = 6                
       THEN 'Jun'                                                               
       WHEN MONTH(COALESCE(TWSC.SYS_BGN_TS,TWSI.SYS_BGN_TS)) = 7                
       THEN 'Jul'                                                               
       WHEN MONTH(COALESCE(TWSC.SYS_BGN_TS,TWSI.SYS_BGN_TS)) = 8                
       THEN 'Aug'                                                               
       WHEN MONTH(COALESCE(TWSC.SYS_BGN_TS,TWSI.SYS_BGN_TS)) = 9                
       THEN 'Sep'                                                               
       WHEN MONTH(COALESCE(TWSC.SYS_BGN_TS,TWSI.SYS_BGN_TS)) = 10               
       THEN 'Oct'                                                               
       WHEN MONTH(COALESCE(TWSC.SYS_BGN_TS,TWSI.SYS_BGN_TS)) = 11               
       THEN 'Nov'                                                               
       WHEN MONTH(COALESCE(TWSC.SYS_BGN_TS,TWSI.SYS_BGN_TS)) = 12               
       THEN 'Dec'                                                               
      END                                                                       
     ,CHAR(DAY(COALESCE(TWSC.SYS_BGN_TS,TWSI.SYS_BGN_TS)))                      
     ,CHAR(TIME(COALESCE(TWSC.SYS_BGN_TS,TWSI.SYS_BGN_TS)),JIS)                 
     ,YEAR(COALESCE(TWSC.SYS_BGN_TS,TWSI.SYS_BGN_TS))                           
                                                                                
             FROM TWSI                                                          
             LEFT OUTER JOIN TWSC                                               
               ON TWSI.ADVC_PROFL_ID = TWSC.ADVC_PROFL_ID                       
              AND TWSI.RBLNC_NO = TWSC.RBLNC_NO                                 
        )                                                                       
        ,                                                                       
       RBL                                                                      
       (                                                                        
          ADVC_PROFL_ID                                                         
         ,FINCL_PLN_FL                                                          
         ,SYS_BGN_TS                                                            
       ) AS                                                                     
       (  SELECT                                                                
               RBLC.ADVC_PROFL_ID                                               
              ,FINCL_PLN_FL                                                     
              ,RBLC.SYS_BGN_TS                                                  
          FROM VT_ADVC_PROF_RBLNC RBLC                                          
          INNER JOIN TWS                                                        
             ON RBLC.ADVC_PROFL_ID = TWS.ADVC_PROFL_ID                          
            AND RBLC.RBLNC_NO  = TWS.TWS_RBLNC_NO                               
          UNION ALL                                                             
          SELECT                                                                
               RBLH.ADVC_PROFL_ID                                               
              ,FINCL_PLN_FL                                                     
              ,RBLH.SYS_BGN_TS                                                  
          FROM VT_ADVC_PROF_RBL_H RBLH                                          
          INNER JOIN TWS                                                        
             ON RBLH.ADVC_PROFL_ID = TWS.ADVC_PROFL_ID                          
            AND RBLH.RBLNC_NO  = TWS.TWS_RBLNC_NO                               
          ORDER BY SYS_BGN_TS DESC                                              
          FETCH FIRST ROW ONLY                                                  
       )                                                                        
         SELECT                                                                 
               TWS.ADVC_PROFL_ID                                                
              ,TWS.TWS_RBLNC_NO                                                 
              ,ADD_INFO.RBL_CUR_RBLNC_NO                                        
              ,TWS.TWS_CREW_PO_ID                                               
              ,TWS.TWS_STATUS_CD                                                
              ,TWS.LST_UPDTD_USER_ID                                            
              ,TS.DAYNAME                  ||' '||                              
               TS.MONTHNAME                ||' '||                              
               SUBSTR(TS.RBLDAY,1,2)       ||' '||                              
               TS.RBLTIME                  ||' '||                              
               'EST'                       ||' '||                              
               TS.RBLYEAR AS LST_UPDTD_TS                                       
              ,RBL.FINCL_PLN_FL                                                 
              ,ADD_INFO.SAG_STATUS_CD                                           
              ,ADD_INFO.IMPLM_BGN_DT                                            
              ,TWS.VALIDT_PRO_CMPL_FL                                           
              ,TWS.RPT_INSTNC_ID                                                
         FROM TWS                                                               
         INNER JOIN RBL                                                         
            ON TWS.ADVC_PROFL_ID = RBL.ADVC_PROFL_ID                            
         INNER JOIN TS                                                          
            ON TS.ADVC_PROFL_ID = TWS.ADVC_PROFL_ID                             
         INNER JOIN ADD_INFO                                                    
            ON ADD_INFO.ADVC_PROFL_ID = TWS.ADVC_PROFL_ID                       
         FOR READ ONLY WITH UR;                                                 
                                                                                
---------------------------------------------------------------------------     
-- THE FOLLOWING CURSOR RETRIEVES CURRENT INFORMATION ABOUT ALL PLANS   .       
-- THAT HAVE BEEN CREATED FOR THE INSTANCE OF REBALANCE ASSOCIATED              
-- WITH THE TRADE WORKSHEET                                                     
---------------------------------------------------------------------------     
 DECLARE PLN_ST_CSR CURSOR WITH RETURN FOR                                      
       WITH MGR_RV                                                              
       ( ADVC_PROFL_ID                                                          
        ,RBLNC_NO                                                               
        ,ADVC_FINC_PLN_ID                                                       
       ) AS                                                                     
       ( SELECT TWS.ADVC_PROFL_ID                                               
               ,TWS.RBLNC_NO                                                    
               ,MRV.ADVC_FINC_PLN_ID                                            
         FROM VT_ADVC_RBL_TWS_ST       TWS                                      
         INNER JOIN VT_ADVC_RBL_MGR_RV MRV                                      
            ON MRV.ADVC_PROFL_ID = TWS.ADVC_PROFL_ID                            
           AND MRV.RBLNC_NO = TWS.RBLNC_NO                                      
         INNER JOIN VADVC_PROFL PRF                                             
            ON PRF.ADVC_PROFL_ID = TWS.ADVC_PROFL_ID                            
         INNER JOIN VSAG_BUS_RLSHP BUS                                          
             ON BUS.SAG_ID = PRF.SAG_ID                                         
         INNER JOIN VSAG SAG                                                    
             ON SAG.SAG_ID = BUS.SAG_ID                                         
         WHERE PRF.EFFTV_BGN_DT        <= CURRENT DATE                          
           AND PRF.EFFTV_END_DT        >  CURRENT DATE                          
           AND SAG.EFFTV_END_DT        > CURRENT DATE                           
           AND SAG.SERV_ID = 413                                                
           AND BUS.PO_ROLE_CD = 'OW'                                            
           AND BUS.PO_ID = p_POID                                               
         UNION ALL                                                              
         SELECT  TWS.ADVC_PROFL_ID                                              
                ,TWS.RBLNC_NO                                                   
                ,MRH.ADVC_FINC_PLN_ID                                           
         FROM VT_ADVC_RBL_TWS_ST TWS                                            
         INNER JOIN VT_ADV_RBL_MG_RV_H MRH                                      
            ON MRH.ADVC_PROFL_ID = TWS.ADVC_PROFL_ID                            
           AND MRH.RBLNC_NO = TWS.RBLNC_NO                                      
         INNER JOIN VADVC_PROFL PRF                                             
            ON PRF.ADVC_PROFL_ID = TWS.ADVC_PROFL_ID                            
         INNER JOIN VSAG_BUS_RLSHP BUS                                          
             ON BUS.SAG_ID = PRF.SAG_ID                                         
         INNER JOIN VSAG SAG                                                    
             ON SAG.SAG_ID = BUS.SAG_ID                                         
         WHERE PRF.EFFTV_BGN_DT        <= CURRENT DATE                          
           AND PRF.EFFTV_END_DT        >  CURRENT DATE                          
           AND SAG.EFFTV_END_DT        > CURRENT DATE                           
           AND SAG.SERV_ID = 413                                                
           AND BUS.PO_ROLE_CD = 'OW'                                            
           AND BUS.PO_ID = p_POID                                               
       )                                                                        
        SELECT DISTINCT                                                         
           MGR_RV.ADVC_PROFL_ID                                                 
          ,MGR_RV.RBLNC_NO                                                      
          ,MGR_RV.ADVC_FINC_PLN_ID                                              
          ,RPT.RPT_RLSE_DT                                                      
          ,RPT.RPT_RLSE_STATUS_CD                                               
          ,COALESCE(AFP.PLN_ACPTD_TS,                                           
           '9999-01-01-01.01.01.000000') AS PLN_ACPTD_TS                        
          ,AFP.EFFTV_BGN_TS AS PLN_TS                                           
        FROM MGR_RV                                                             
        INNER JOIN VADVC_FINCL_PLN AFP                                          
           ON MGR_RV.ADVC_FINC_PLN_ID = AFP.ADVC_FINC_PLN_ID                    
        INNER JOIN VRPT_INSTNC RPT                                              
           ON RPT.RPT_INSTNC_ID = AFP.RPT_INSTNC_ID                             
        ORDER BY PLN_TS DESC                                                    
        FOR READ ONLY WITH UR;                                                  
--                                                                              
-- SQL CONDITIONS                                                               
--                                                                              
-- DECLARE CONTINUE HANDLER FOR SQLEXCEPTION SET ERRORCODE = SQLCODE            
---------------------------------------------------------------------------     
-- GET SQLCODE, SQLSTATE, and SQLERRMC from SQLCA                               
---------------------------------------------------------------------------     
   DECLARE CONTINUE HANDLER FOR SQLEXCEPTION                                    
     BEGIN                                                                      
       GET DIAGNOSTICS EXCEPTION 1 v_ERR_MSG  = MESSAGE_TEXT,                   
                                 RETCODE      = DB2_RETURNED_SQLCODE,           
                                 v_SQLSTATE   = RETURNED_SQLSTATE;              
       SET p_ETEXT = v_ERR_MSG;                                                 
     END;                                                                       
--                                                                              
   DECLARE CONTINUE HANDLER FOR SQLWARNING                                      
     BEGIN                                                                      
       GET DIAGNOSTICS EXCEPTION 1 v_ERR_MSG    = MESSAGE_TEXT,                 
                                 RETCODE        = DB2_RETURNED_SQLCODE,         
                                 v_SQLSTATE     = RETURNED_SQLSTATE;            
       SET p_ETEXT = v_ERR_MSG;                                                 
     END;                                                                       
--                                                                              
--                                                                              
-- INTIALIZE VARIABLES                                                          
                                                                                
   SET p_ESEVERE = '';                                                          
   SET p_ETEXT = '';                                                            
   SET p_EDBAVAIL = 'Y';                                                        
   SET p_ENUM = 0;                                                              
   SET p_EGROUP = 0;                                                            
   SET p_ESQLCD = 0;                                                            
   SET p_EPGM = 'ESAN350E';                                                     
--                                                                              
-- VERIFY AND SET PACKAGESET                                                    
--                                                                              
   IF p_PACKAGE = '' THEN                                                       
      SET p_ENUM = 1100;                                                        
      SET p_ESEVERE = 'S';                                                      
      SET p_EGROUP = 4;                                                         
      SET v_ERR_LOG_FL = 'T';                                                   
      SET p_ETEXT = 'PACKAGESET IS INVALID';                                    
      GOTO THEEND;                                                              
   END IF;                                                                      
--                                                                              
-- SET PACKAGESET                                                               
--                                                                              
   SET CURRENT PACKAGESET = p_PACKAGE;                                          
   IF RETCODE <> 0 THEN                                                         
      SET p_ENUM = 1120;                                                        
      SET p_ESEVERE = 'S';                                                      
      SET v_ERR_LOG_FL = 'T';                                                   
      SET p_EGROUP = 5;                                                         
      SET p_ETEXT = 'UNABLE TO SET PACKAGESET';                                 
      GOTO THEEND;                                                              
   END IF;                                                                      
--                                                                              
-- SET CURRENT TIMESTAMP                                                        
--                                                                              
   SET p_TS = CURRENT TIMESTAMP;                                                
   IF RETCODE  <> 0 THEN                                                        
      SET p_ENUM = 1300;                                                        
      SET p_ESEVERE = 'S';                                                      
      SET v_ERR_LOG_FL = 'D';                                                   
      SET p_EGROUP = 4;                                                         
      GOTO THEERROR;                                                            
   END IF;                                                                      
----------------------------------------------------------------                
-- VALIDATE and LOAD                                                            
----------------------------------------------------------------                
    SET v_POID = p_POID;                                                        
    IF v_POID <= 0 THEN                                                         
      SET p_ENUM = 1400;                                                        
      SET p_ESEVERE = 'S';                                                      
      SET v_ERR_LOG_FL = 'T';                                                   
      SET p_EGROUP = 4;                                                         
      SET p_ETEXT = 'p_ADVC_PROFL_ID IS SPACES';                                
      GOTO THEERROR;                                                            
    END IF;                                                                     
    SET RETCODE = 0;                                                            
    OPENCSR:                                                                    
       OPEN TW_ST_CSR;                                                          
       IF RETCODE <> 0 THEN                                                     
          SET p_ENUM       = 1500;                                              
          SET p_ESEVERE    = 'S';                                               
          SET v_ERR_LOG_FL = 'T';                                               
          GOTO THEERROR;                                                        
       END IF;                                                                  
                                                                                
       OPEN PLN_ST_CSR;                                                         
       IF RETCODE <> 0 THEN                                                     
          SET p_ENUM       = 1501;                                              
          SET p_ESEVERE    = 'S';                                               
          SET v_ERR_LOG_FL = 'T';                                               
          GOTO THEERROR;                                                        
       END IF;                                                                  
       GOTO THEEND;                                                             
--                                                                              
-- ERROR HANDLING                                                               
--                                                                              
   THEERROR:                                                                    
     SET p_ESQLCD = RETCODE;                                                    
     CALL DISO100A                                                              
            ( p_PACKAGE                                                         
             ,p_APPNM                                                           
             ,p_USERID                                                          
             ,p_APPLID                                                          
             ,p_TS                                                              
             ,p_ESEVERE                                                         
             ,p_ENUM                                                            
             ,p_EGROUP                                                          
             ,p_ESQLCD                                                          
             ,p_EPGM                                                            
             ,p_ETEXT                                                           
             ,p_EDBAVAIL                                                        
             ,v_SQLSTATE                                                        
             ,v_ERR_MSG                                                         
             ,v_ERR_LOG_FL ); COMMIT;                                           
--- DISPLAY MESSAGE                                                             
       IF RETCODE <> 0 THEN                                                     
          SET v_DISPL_MSG = 'CALL TO DISO100A FAILED ' ||                       
                            'SQLCODE = '               ||                       
                             CHAR(RETCODE);                                     
          SET v_LABEL = 'RET_DISO100A';                                         
          GOTO DISPLAY;                                                         
       END IF;                                                                  
--                                                                              
    RET_DISO100A:                                                               
       GOTO THEEND;                                                             
--                                                                              
    DISPLAY:                                                                    
       IF v_DEBUG_MODE_FL = 'Y' THEN                                            
          CALL DISO101A                                                         
               ( p_PACKAGE                                                      
                ,p_APPNM                                                        
                ,p_USERID                                                       
                ,p_APPLID                                                       
                ,p_TS                                                           
                ,p_ESEVERE                                                      
                ,p_ENUM                                                         
                ,p_EGROUP                                                       
                ,p_ESQLCD                                                       
                ,p_EPGM                                                         
                ,p_ETEXT                                                        
                ,p_EDBAVAIL                                                     
                ,v_DISPL_MSG                                                    
              );                                                                
       END IF;                                                                  
-- USE LABEL AND CASE to get PERFORM FUNCTIONALITY                              
       CASE v_LABEL                                                             
         WHEN 'RET_DISO100A'                                                    
            THEN GOTO RET_DISO100A;                                             
         ELSE                                                                   
            GOTO THEEND;                                                        
       END CASE;                                                                
--                                                                              
-- END OF PROCESSING                                                            
--                                                                              
   THEEND:                                                                      
     SET p_ESQLCD = RETCODE;                                                    
     SET p_TS     = CURRENT TIMESTAMP;                                          
   END                                                                          
 ต                                                                              
--                                                                              
--#SET TERMINATOR ;                                                             
--                                                                              
   COMMIT;                                                                      