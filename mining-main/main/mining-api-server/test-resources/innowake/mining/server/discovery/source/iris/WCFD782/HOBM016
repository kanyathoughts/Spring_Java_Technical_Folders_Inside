000100*#PREVIEW# PROGRAM REVIEW UNDTAGET
000200 ID DIVISION.
000300 PROGRAM-ID.         HOBM016.
000400 AUTHOR.             DAN SHAPIRA.
000500 DATE-WRITTEN.       01122010.
000600 DATE-COMPILED.
000700*-----------------------------------------------------------------
000800*REVIEW    :
000900*-----------------------------------------------------------------
001000*SPC>        INGEN SPECIALPROGRAMMERING
001100*-----------------------------------------------------------------
001200* FUNKTION : PROGRAMMET UDTRÆKKER PROFILOPLYSNINGER.
001300*            PROGRAMMET ER EN EXTRAKT AF LOGIK FRA HOBW9418
001400*-----------------------------------------------------------------
001500* OUTPUT   : INCLUDE HOBOUTPI
001600*
001700* TABELLER : HOBTB204 HOBTB320 HOBTB341
001800*
001900* MODULER  : HOBSETPT HOBMF009 HOBMF005 BDSDATO  KISM505M
002000*            HOBMF138 EDIM063
002100*-----------------------------------------------------------------
002200* ÆNDRINGER
002300*
002400* DATO     INIT   BESKRIVELSE
002500* -------- ----   -----------------------------------------------
002600* 03.03.10 UBIMAH Update af DanID migrering til selvstændig BDSCH.
002700* 23.03.10 UBIGRN Cert m. ngl. undtagelse fra ren ngl.
002800* 01.12.10 OMSKRIVNING SOM M MODUL MED LOGIK FRA HOBW9418
002900* 07.04.11 Kalder til HOBD402 for at finde ud af om kunde er SEPA
003000* 31.05.11 UBIPBE Nyt felt: Mobil-dag-max-bel
003100* 06.06.12 UBILCS Nyt felt: BEH-SPOR-KD - findes via EDIM063
003200* 13.11.12 UBILCS Kun ét betalingsflow (HOBMF572 udgår)
003300* 03.07.14 UBILSS UDVID INTERFACE MED DANID AKTIVERINGSPERIODE
003400*                 DATO + X-DAGE
003500* 22.10.14 UBICAL Fjern kald til KISD093
003600* 23.10.14 UBILSS Ændret A-start fra 10 til 15 dage.
003700*                 Ændret migreringsdato slut fra +30 til 35 dage
003800* 15.01.16 UBIBRM Fjernelse af ikke brugte SDDM015 referencer
003900* 20.04.16 UBIPWL Ud af certifikat
003910* 28.05.19 UBIBRM Selektiv undladelse af navneformattering jf.
003920*                 incident 630713
004000*-----------------------------------------------------------------
004100 ENVIRONMENT DIVISION.
004200 CONFIGURATION SECTION.
004300 SPECIAL-NAMES.
004400     DECIMAL-POINT IS COMMA.
004500 INPUT-OUTPUT SECTION.
004600 FILE-CONTROL.
004700 DATA DIVISION.
004800*-----------------------------------------------------------------
004900*    WORKING STORAGE
005000*-----------------------------------------------------------------
005100 WORKING-STORAGE SECTION.
005200      REPLACE ==:BDSIXXX:== BY ==HOBM016==.
005300*-----------------------------------------------------------------
005400*    KONSTANTER
005500*-----------------------------------------------------------------
005600 01 WS-PROGRAMNAVN            PIC  X(08) VALUE 'HOBM016'.
005700*-----------------------------------------------------------------
005800*    VARIABLER
005900*-----------------------------------------------------------------
006000 01  FASTE-WORK-FELTER.
006100     COPY BDSIWKSD.
006200
006300 01 WS-POSITION               PIC  9(07).
006400 01 WS-DAGSDATO               PIC  9(08).
006500 01 WS-CPR-COMP3              PIC  9(10) COMP-3.
006600 01 WS-FODSELSDAG             PIC  9(08).
006700 01 WS-TID                    PIC  X(08).
006800 01 WS-DATO-BEREGNET          PIC X(08)        VALUE SPACES.
006900 01 WS-ANTALDAGE              PIC S9(09) COMP  VALUE 0.
007000 01 WS-DB2DATO.
007100    03 FILLER-YYYY            PIC  X(04).
007200    03 FILLER-STREG1          PIC  X(01).
007300    03 FILLER-MM              PIC  X(02).
007400    03 FILLER-STREG2          PIC  X(01).
007500    03 FILLER-DD              PIC  X(02).
007600
007700 01 WS-DB2TIMESTP.
007800    03 FILLER-YYYY            PIC  X(04).
007900    03 FILLER-STREG1          PIC  X(01).
008000    03 FILLER-MM              PIC  X(02).
008100    03 FILLER-STREG2          PIC  X(01).
008200    03 FILLER-DD              PIC  X(02).
008300    03 FILLER-STREG3          PIC  X(01).
008400    03 FILLER-TT              PIC  X(02).
008500    03 FILLER-STREG4          PIC  X(01).
008600    03 FILLER-MN              PIC  X(02).
008700    03 FILLER-STREG5          PIC  X(01).
008800    03 FILLER-SS              PIC  X(02).
008900    03 FILLER-STREG6          PIC  X(01).
009000 01 WS-DB2DATO-FORMAT.
009100    03 FILLER-YYYY            PIC  9(04).
009200    03 FILLER-MM              PIC  9(02).
009300    03 FILLER-DD              PIC  9(02).
009400 01 WS-DB2TID-FORMAT.
009500    03 FILLER-TT              PIC  9(02).
009600    03 FILLER-MN              PIC  9(02).
009700    03 FILLER-SS              PIC  9(02).
009800 01 WS-ALDER-FELTER.
009900    03 FORSKEL-AAR            PIC  S9(9) COMP.
010000    03 TEMP-FORSKEL-AAR       PIC  S9(9).
010100    03 FORSKEL-DAGE           PIC  S9(9) COMP.
010200    03 TEMP-FORSKEL-DAGE      PIC  S9(9).
010300    03 WS-CPRNR               PIC  X(10).
010400    03 WS-DATO-NUM            PIC  9(08).
010500    03 WS-DATO                PIC  X(10).
010600
010700 01 TEST-KONVERTERES          PIC  X(32) VALUE SPACES.
010800    88 KONVERTERES-IKKE       value 'BJ-Gear A/S'
010900                                  , 'Eksport A/S - DEMO'.
011000*-----------------------------------------------------------------
011100*    INCLUDES DIV
011200*-----------------------------------------------------------------
011300
011400 01  HOBINGL-PARM.
011500     COPY HOBINGL.
011600
011700 01  HOBMF138-PARM.
011800     COPY HOBIF138.
011900*
012000 01  HOBMFJL-PARM.
012100     COPY HOBMFJLI.
012200*
012300 01  BDSDATOCP.
012400     COPY BDSDATOC.
012500*
012600 01  HOBMF005-PARM.
012700     COPY HOBIF005.
012800*
012900 01  HOBMT203-PARM.
013000     COPY HOBMI203.
013100*
013200 01  HOBMT261-PARM.
013300     COPY HOBMI261.
013400*
013500 01  KISM000I-WORK.
013600     COPY KISM000I.
013700*
013800 01  KISM505M-PARM.
013900     COPY KISM505I.
014000
014100 01  HOBMT346-PARM.
014200     COPY HOBMI346.
014300
014400 01  HOBMF612-PARM.
014500     COPY HOBIF612.
014600
014700 01  HOBD402-PARM.
014800     COPY HOBD402I.
014900
015000 01  EDIM063-PARM.
015100     COPY EDIM063I.
015200
015300*-----------------------------------------------------------------
015400*    DATABASER - DB2
015500*-----------------------------------------------------------------
015600     EXEC SQL INCLUDE SQLCA    END-EXEC.
015700     COPY DB2FEJLI.
015800     EXEC SQL INCLUDE HOBTB204 END-EXEC.
015900     EXEC SQL INCLUDE HOBTB320 END-EXEC.
016000*-----------------------------------------------------------------
016100*    POINTERS
016200*-----------------------------------------------------------------
016300*01  OUTPUT-POINTER           POINTER.
016400*01  OUTPUT-POINTER-ELEM      POINTER.
016500*-----------------------------------------------------------------
016600 LINKAGE SECTION.
016700*-----------------------------------------------------------------
016800*
016900 01  HOBM016-PARM.
017000     COPY HOBM016I.
017100
017200*-----------------------------------------------------------------
017300 PROCEDURE DIVISION USING HOBM016-PARM.
017400
017500*-----------------------------------------------------------------
017600 000-HOVEDSTYRING SECTION.
017700*-----------------------------------------------------------------
017800     PERFORM 010-INIT
017900     PERFORM 200-OPBYG-UDTRAEK
018000     PERFORM 900-AFSLUTNING
018100     .
018200*-----------------------------------------------------------------
018300 002-AFSLUT SECTION.
018400*-----------------------------------------------------------------
018500
018600     GOBACK
018700     .
018800*-----------------------------------------------------------------
018900 010-INIT SECTION.
019000*-----------------------------------------------------------------
019100* HER INITIERES OPSTARTSVÆRDIER.
019200*-----------------------------------------------------------------
019300     INITIALIZE HOBM016-OUTPUT
019400                TEST-KONVERTERES
019500
019600     MOVE KUNDENR IN HOBM016-input
019700       TO KALDENDE-KUNDENR IN HOBMF138-PARM
019800          BDSMFJL-KALDENDE-KUNDENR
019900     MOVE BRUGERNR IN HOBM016-INPUT
020000       TO KALDENDE-BRUGER  IN HOBMF138-PARM
020100          BDSMFJL-KALDENDE-BRUGERNR
020200
020300     MOVE HOBM016-INPUT
020400       TO KALDENDE-PARM              IN HOBMF138-PARM
020500     SET STATU-OK IN HOBM016-PARM TO TRUE
020600*    MOVE 0     TO RETUR-KODE      IN HOBM016_PARM
020700     MOVE SPACE TO MEDD-TEKST1 IN HOBM016-PARM
020800     MOVE SPACE TO MEDD-TEKST2 IN HOBM016-PARM
020900
021000     .
021100*-----------------------------------------------------------------
021200 200-OPBYG-UDTRAEK SECTION.
021300*-----------------------------------------------------------------
021400* DANNER SELVE UDTRÆKKET.
021500*-----------------------------------------------------------------
021600     MOVE 0 TO
021700               STATUS-KODE   IN hobm016-output
021800*TBS START
021900     PERFORM 210-KALD-HOBMT203
022000*TBS END
022100     PERFORM 220-KALD-HOBMF005
022200     PERFORM 230-LAES-HOBTB320
022300     PERFORM 270-UDFYLD-LOG-I-SUPPORT-LOG
022400     PERFORM 280-UDFYLD-LDAP-UID
022500     PERFORM 240-UDFYLD-C-VAR
022600     PERFORM 250-LAES-HOBTB204
022700     MOVE 'J' TO E-FLOW IN HOBM016-OUTPUT
022800     PERFORM 300-LOKAL-BRUGER
022900     PERFORM 310-TJEK-IP-WHITELIST
023000     PERFORM 320-FIND-DANID-STATUS
023100     PERFORM 331-TJEK-SEPA-DD-NY
023200     PERFORM 350-FIND-BEH-SPOR-KD
023300     .
023400*-----------------------------------------------------------------
023500 210-KALD-HOBMT203 SECTION.
023600*-----------------------------------------------------------------
023700     SET FUNK-LAES  IN HOBMT203-PARM TO TRUE
023800
023900     MOVE BANKNR    IN HOBM016-INPUT
024000       TO BANKNR    IN HOBTD203-IO
024100     MOVE KUNDENR   IN HOBM016-INPUT
024200       TO KUNDENR   IN HOBTD203-IO
024300
024400     CALL 'HOBMT203' USING HOBMT203-PARM
024500     IF STATU-OK IN HOBMT203-PARM
024600        CONTINUE
024700     ELSE
024800*       MOVE RETURKODE-AREAL IN HOBMT203-PARM
024900*         TO RETURKODE-AREAL IN HOBM016-PARM
025000
025100        move STATU-KD in HOBMT203-PARM
025200          TO STATU-KD in HOBM016-PARM
025300        move MEDD-TEKST1 in HOBMT203-PARM
025400          TO MEDD-TEKST1 in HOBM016-PARM
025500        move FEJL-ID in HOBMT203-PARM
025600          TO FEJL-ID in HOBM016-PARM
025700        move IDENT-AREAL IN HOBMT203-PARM
025800          TO IDENT-AREAL in HOBM016-PARM
025900          move MEDD-ID in HOBMT203-PARM
026000            TO MEDD-ID in HOBM016-PARM
026100          move MEDD-kd in HOBMT203-PARM
026200            TO MEDD-kd in HOBM016-PARM
026300        SET FUNK-CALL-FEJL IN HOBMF138-PARM TO TRUE
026400        MOVE '210-KALD-HOBMT203'
026500          TO KALDENDE-SECTION IN HOBMF138-PARM
026600        MOVE FUNKTION      IN HOBMT203-PARM
026700          TO KALD-FUNKTION IN HOBMF138-PARM
026800        MOVE 'HOBMT203'
026900          TO KALD-PRG      IN HOBMF138-PARM
027000        MOVE STATU-KD      IN HOBMT203-PARM
027100          TO KALD-KD       IN HOBMF138-PARM
027200        MOVE MEDD-TEKST1   IN HOBMT203-PARM
027300          TO KALD-MEDD1    IN HOBMF138-PARM
027400        MOVE MEDD-TEKST2   IN HOBMT203-PARM
027500          TO KALD-MEDD2    IN HOBMF138-PARM
027600        MOVE HOBMT203-PARM
027700          TO KALD-PARM     IN HOBMF138-PARM
027800
027900        IF STATU-FEJL IN HOBMT203-PARM
028000           SET ALVORLIG-FEJL    IN HOBMF138-PARM TO TRUE
028100        ELSE
028200           SET INGEN            IN HOBMF138-PARM TO TRUE
028300        END-IF
028400        PERFORM 790-KALD-FEJL-MEDMOD
028500        SET STATU-SYSTEMFEJL IN HOBM016-PARM TO TRUE
028600        PERFORM 900-AFSLUTNING
028700     END-IF
028800     .
028900*-----------------------------------------------------------------
029000 220-KALD-HOBMF005 SECTION.
029100*-----------------------------------------------------------------
029200* FINDER DAGMAX, HOTLINE TLF, VALIDE OG PRIMÆR SIKKERHEDSLØSNINGER
029300*-----------------------------------------------------------------
029400     INITIALIZE HOBMF005-PARM
029500
029600     SET  FUNK-LAES-PROFIL       TO TRUE
029700
029800     MOVE BANKNR  IN HOBM016-INPUT TO BANKNR IN HOBMF005-PARM
029900     MOVE KUNDENR IN HOBM016-INPUT TO KUNDENR IN HOBMF005-PARM
030000     MOVE MEDIENR IN HOBM016-INPUT TO MEDIENR IN HOBMF005-PARM
030100*TBS START
030200     MOVE GRP-PROF-ID IN HOBTD203-IO
030300                             TO GRP-PROF-ID IN HOBMF005-PARM
030400*TBS END
030500
030600     CALL 'HOBMF005' USING HOBMF005-PARM
030700
030800     IF NOT STATU-OK IN HOBMF005-PARM
030900        MOVE 'CALLFEJL - HOBMF005'
031000          TO MEDD-TEKST1     IN HOBM016-PARM
031100        move STATU-KD in HOBMF005-PARM
031200          TO STATU-KD in HOBM016-PARM
031300        move FEJL-ID in HOBMF005-PARM
031400          TO FEJL-ID in HOBM016-PARM
031500        move IDENT-AREAL IN HOBMF005-PARM
031600          TO IDENT-AREAL in HOBM016-PARM
031700          move MEDD-ID in HOBMF005-PARM
031800            TO MEDD-ID in HOBM016-PARM
031900          move MEDD-kd in HOBMF005-PARM
032000            TO MEDD-kd in HOBM016-PARM
032100*       MOVE RETURKODE-AREAL IN HOBMF005-PARM
032200*         TO RETURKODE-AREAL IN HOBM016-PARM
032300        SET FUNK-CALL-FEJL IN HOBMF138-PARM TO TRUE
032400        MOVE '220-KALD-HOBMF005'
032500          TO KALDENDE-SECTION IN HOBMF138-PARM
032600        MOVE FUNKTION      IN HOBMF005-PARM
032700          TO KALD-FUNKTION IN HOBMF138-PARM
032800        MOVE 'HOBMF005'
032900          TO KALD-PRG      IN HOBMF138-PARM
033000        MOVE STATU-KD      IN HOBMF005-PARM
033100          TO KALD-KD       IN HOBMF138-PARM
033200        MOVE MEDD-TEKST1   IN HOBMF005-PARM
033300          TO KALD-MEDD1    IN HOBMF138-PARM
033400        MOVE MEDD-TEKST2   IN HOBMF005-PARM
033500          TO KALD-MEDD2    IN HOBMF138-PARM
033600        MOVE HOBMF005-PARM
033700          TO KALD-PARM     IN HOBMF138-PARM
033800
033900        IF STATU-FEJL IN HOBMF005-PARM
034000           SET ALVORLIG-FEJL    IN HOBMF138-PARM TO TRUE
034100        ELSE
034200           SET INGEN            IN HOBMF138-PARM TO TRUE
034300        END-IF
034400
034500        PERFORM 790-KALD-FEJL-MEDMOD
034600
034700
034800        PERFORM 900-AFSLUTNING
034900     END-IF
035000
035100     MOVE HOTL-TLFNR    IN HOBMF005-PARM
035200       TO HOTL-TLFNR    IN hobm016-output
035300
035400     MOVE VALID-SIKHED-LOSN IN HOBMF005-PARM TO
035500                  VALIDSECURITYSOLUTION IN
035600                            hobm016-output
035700
035800     MOVE PRIM-SIKHED-LOSN  IN HOBMF005-PARM
035900       TO PRIM-SIKHED-LOSN  IN hobm016-output
036000     MOVE VALID-SIKHED-LOSN IN HOBMF005-PARM
036100       TO VALID-SIKHED-LOSN IN hobm016-output
036200     MOVE RET-LEV-KD        IN HOBMF005-PARM
036300       TO RET-LEV-KD        IN hobm016-output
036400     MOVE CO-NAVN-KD        IN HOBMF005-PARM
036500       TO CO-NAVN-KD        IN hobm016-output
036600     MOVE DAG-MAX-BET-BEL   IN HOBMF005-PARM
036700       TO DAG-MAX-BET-BEL   IN hobm016-output
036800     MOVE MOBIL-DAG-MAX-BEL IN HOBMF005-PARM
036900       TO MOBIL-DAG-MAX-BEL IN hobm016-output
037000     .
037100*-----------------------------------------------------------------
037200 230-LAES-HOBTB320 SECTION.
037300*-----------------------------------------------------------------
037400* FINDER OPLYSNINGER OM SENESTE-OPKALD
037500*-----------------------------------------------------------------
037600     MOVE BANKNR   IN HOBM016-INPUT TO BANKNR   IN HOBTB320
037700     MOVE KUNDENR  IN HOBM016-INPUT TO KUNDENR  IN HOBTB320
037800     MOVE BRUGERNR IN HOBM016-INPUT TO BRUGERNR IN HOBTB320
037900     MOVE MEDIENR  IN HOBM016-INPUT TO MEDIENR  IN HOBTB320
038000
038100     EXEC SQL
038200        SELECT SENEST_OPKALD_TID
038300             , LOG_TRANS_KD
038400             , LOG_SLUT_DATO
038500        INTO  :HOBTB320.SENEST-OPKALD-TID
038600              :HOBTB320.NULL-SENEST-OPKALD-TID
038700             ,:HOBTB320.LOG-TRANS-KD
038800              :HOBTB320.NULL-LOG-TRANS-KD
038900             ,:HOBTB320.LOG-SLUT-DATO
039000              :HOBTB320.NULL-LOG-SLUT-DATO
039100        FROM   HOBTB320_BRU_MEDIE
039200        WHERE  BANKNR   = :HOBTB320.BANKNR
039300        AND    KUNDENR  = :HOBTB320.KUNDENR
039400        AND    BRUGERNR = :HOBTB320.BRUGERNR
039500        AND    MEDIENR  = :HOBTB320.MEDIENR
039600     END-EXEC
039700
039800     IF DB2-OK
039900        CONTINUE
040000     ELSE
040100        MOVE 'DER ER DB-FEJL I HOBM016'
040200          TO MEDD-TEKST1  IN HOBM016-PARM
040300        MOVE SQLCA
040400          TO MEDD-TEKST2  IN HOBM016-PARM
040500        MOVE DB2FEJLEN
040600          TO fejl-id      IN HOBM016-PARM
040700
040800        SET FUNK-SQL-FEJL IN HOBMF138-PARM TO TRUE
040900        MOVE '230-LAES-HOBTB320'
041000          TO KALDENDE-SECTION  IN HOBMF138-PARM
041100        MOVE SQLCA
041200          TO SQL-SQLCA     IN HOBMF138-PARM
041300        MOVE HOBTB320
041400          TO SQL-TABEL-INDHOLD IN HOBMF138-PARM
041500
041600        MOVE 'HOBTB320'
041700          TO SQL-TBL1          IN HOBMF138-PARM
041800        MOVE BANKNR            IN HOBTB320
041900          TO SQL-NGL1          IN HOBMF138-PARM
042000        MOVE KUNDENR           IN HOBTB320
042100          TO SQL-NGL2          IN HOBMF138-PARM
042200        MOVE BRUGERNR          IN HOBTB320
042300          TO SQL-NGL3          IN HOBMF138-PARM
042400        MOVE MEDIENR           IN HOBTB320
042500          TO SQL-NGL4          IN HOBMF138-PARM
042600
042700        SET ALVORLIG-FEJL IN HOBMF138-PARM TO TRUE
042800        PERFORM 790-KALD-FEJL-MEDMOD
042900        SET STATU-SYSTEMFEJL IN HOBM016-PARM TO TRUE
043000        PERFORM 900-AFSLUTNING
043100     END-IF
043200
043300     MOVE SPACE
043400         TO CERTIFIKAT-TYPE IN hobm016-output
043500
043600
043700     MOVE 'N' TO BRUGES-CERTIFIKAT-LOSN
043800                 IN hobm016-output
043900
044000     IF SENEST-OPKALD-TID-N    IN HOBTB320
044100        MOVE 0 TO DATO-SENEST-OPKALD
044200               IN hobm016-output
044300        MOVE 0 TO TID-SENEST-OPKALD
044400               IN hobm016-output
044500     ELSE
044600        MOVE SENEST-OPKALD-TID IN HOBTB320 TO WS-DB2TIMESTP
044700        MOVE CORR WS-DB2TIMESTP            TO WS-DB2DATO-FORMAT
044800        MOVE CORR WS-DB2TIMESTP            TO WS-DB2TID-FORMAT
044900        MOVE WS-DB2DATO-FORMAT
045000          TO DATO-SENEST-OPKALD IN hobm016-output
045100        MOVE WS-DB2TID-FORMAT
045200          TO TID-SENEST-OPKALD  IN hobm016-output
045300     END-IF
045400
045500*DER CHECKES LIGE OM BRUGER ER MOB-BRUGER TIL PORTALET
045600     EXEC SQL
045700        SELECT BANKNR
045800          INTO :HOBTB320.BANKNR
045900          FROM HOBTB320_BRU_MEDIE
046000         WHERE BANKNR   = :HOBTB320.BANKNR
046100           AND KUNDENR  = :HOBTB320.KUNDENR
046200           AND BRUGERNR = :HOBTB320.BRUGERNR
046300           AND MEDIENR  = 3
046400     END-EXEC
046500
046600     IF DB2-OK OR DB2-NOT-FOUND
046700        IF DB2-OK
046800           MOVE 'Y' TO BRUGER-ER-MOB-BRUGER
046900                    IN hobm016-output
047000        ELSE
047100           MOVE 'N' TO BRUGER-ER-MOB-BRUGER
047200                    IN hobm016-output
047300        END-IF
047400     ELSE
047500        MOVE 'DER ER DB-FEJL I HOBM016'
047600          TO MEDD-TEKST1  IN HOBM016-PARM
047700        MOVE SQLCA
047800          TO MEDD-TEKST2  IN HOBM016-PARM
047900        MOVE DB2FEJLEN
048000          TO fejl-id IN HOBM016-PARM
048100
048200        SET FUNK-SQL-FEJL IN HOBMF138-PARM TO TRUE
048300        MOVE '230-LAES-HOBTB320'
048400          TO KALDENDE-SECTION  IN HOBMF138-PARM
048500        MOVE SQLCA
048600          TO SQL-SQLCA     IN HOBMF138-PARM
048700        MOVE HOBTB320
048800          TO SQL-TABEL-INDHOLD IN HOBMF138-PARM
048900
049000        MOVE 'HOBTB320'
049100          TO SQL-TBL1          IN HOBMF138-PARM
049200        MOVE BANKNR            IN HOBTB320
049300          TO SQL-NGL1          IN HOBMF138-PARM
049400        MOVE KUNDENR           IN HOBTB320
049500          TO SQL-NGL2          IN HOBMF138-PARM
049600        MOVE BRUGERNR          IN HOBTB320
049700          TO SQL-NGL3          IN HOBMF138-PARM
049800        MOVE 3
049900          TO SQL-NGL4          IN HOBMF138-PARM
050000        SET ALVORLIG-FEJL IN HOBMF138-PARM TO TRUE
050100
050200        PERFORM 790-KALD-FEJL-MEDMOD
050300
050400        SET STATU-SYSTEMFEJL IN HOBM016-PARM TO TRUE
050500
050600        PERFORM 900-AFSLUTNING
050700     END-IF
050800     .
050900*-----------------------------------------------------------------
051000 240-UDFYLD-C-VAR  SECTION.
051100*-----------------------------------------------------------------
051200* CERTIFIKATLØSNING ER UDFASET. SÆTTER N I VARIALE TIL OUTPUT
051300*-----------------------------------------------------------------
051400      MOVE 'N'
051500           TO BRUGES-TAN-LOSN IN hobm016-output
051600      MOVE 'N'
051700           TO FINDES-TAN-LOSN IN hobm016-output
051800      MOVE 'N'
051900           TO CERT-M-NGL-PAA-BRUGER
052000           IN hobm016-output
052100      MOVE 'N'
052200           TO CERT-NGL-K-NGL
052300           IN hobm016-output
052400      MOVE 'N'
052500           TO HARW-BINDING-AKTIV-JN IN hobm016-output
052600     .
052700*-----------------------------------------------------------------
052800 250-LAES-HOBTB204 SECTION.
052900*-----------------------------------------------------------------
053000* FINDER NAVN - OG FØDSELSDATO UDFRA CPRNR
053100*-----------------------------------------------------------------
053200     MOVE BANKNR   IN HOBM016-INPUT TO BANKNR IN HOBTB320
053300     MOVE KUNDENR  IN HOBM016-INPUT TO KUNDENR IN HOBTB320
053400     MOVE BRUGERNR IN HOBM016-INPUT TO BRUGERNR IN HOBTB320
053500
053600     EXEC SQL
053700        SELECT A.NAVN
053800             , A.CPRNR
053900             , A.BORS_HANDEL_KD
054000             , A.MARKED_DYBDE_KD
054100             , A.REAL_TID_KURS_KD
054200             , A.BORS_SPAER_KD
054300             , A.UDL_BORS_AFTALE_KD
054400             , A.GMS_AFTALE_KD
054500             , A.DANID_AKTIV_KD
054600             , A.DANID_MIGR_DATO
054700        INTO  :HOBTB204.NAVN
054800             ,:HOBTB204.CPRNR
054900              :HOBTB204.NULL-CPRNR
055000             ,:HOBTB204.BORS-HANDEL-KD
055100             ,:HOBTB204.MARKED-DYBDE-KD
055200             ,:HOBTB204.REAL-TID-KURS-KD
055300             ,:HOBTB204.BORS-SPAER-KD
055400             ,:HOBTB204.UDL-BORS-AFTALE-KD
055500             ,:HOBTB204.GMS-AFTALE-KD
055600             ,:HOBTB204.DANID-AKTIV-KD
055700             ,:HOBTB204.DANID-MIGR-DATO
055800              :HOBTB204.NULL-DANID-MIGR-DATO
055900        FROM   HOBTB204_BRUGER A
056000        WHERE  A.BANKNR   = :HOBTB320.BANKNR
056100        AND    A.KUNDENR  = :HOBTB320.KUNDENR
056200        AND    A.BRUGERNR = :HOBTB320.BRUGERNR
056300     END-EXEC
056400
056500     IF NOT DB2-OK
056600              MOVE 'DER ER DB-FEJL I HOBM016'
056700                TO MEDD-TEKST1  IN HOBM016-PARM
056800              MOVE SQLCA
056900                TO MEDD-TEKST2  IN HOBM016-PARM
057000              MOVE DB2FEJLEN
057100                TO fejl-id      IN HOBM016-PARM
057200              SET FUNK-SQL-FEJL IN HOBMF138-PARM TO TRUE
057300              MOVE '250-LAES-HOBTB204'
057400                TO KALDENDE-SECTION  IN HOBMF138-PARM
057500              MOVE SQLCA
057600                TO SQL-SQLCA     IN HOBMF138-PARM
057700              MOVE HOBTB204
057800                TO SQL-TABEL-INDHOLD IN HOBMF138-PARM
057900              MOVE 'HOBTB204'
058000                TO SQL-TBL1          IN HOBMF138-PARM
058100              MOVE BANKNR            IN HOBTB320
058200                TO SQL-NGL1          IN HOBMF138-PARM
058300              MOVE KUNDENR           IN HOBTB320
058400                TO SQL-NGL2          IN HOBMF138-PARM
058500              MOVE BRUGERNR          IN HOBTB320
058600                TO SQL-NGL3          IN HOBMF138-PARM
058700              SET ALVORLIG-FEJL IN HOBMF138-PARM TO TRUE
058800
058900              PERFORM 790-KALD-FEJL-MEDMOD
059000
059100              SET STATU-SYSTEMFEJL IN HOBM016-PARM TO TRUE
059200
059300              PERFORM 900-AFSLUTNING
059400     END-IF
059500
059600*TBS START
059700     MOVE BANK-KUNDE-KD IN HOBTD203-IO
059800*TBS END
059900       TO BANK-KUNDE-KD IN hobm016-output
060000
060100     PERFORM 260-KONV-NAVN-TIL-STOR-SMAA
060200     MOVE NAVN IN HOBTD203-IO TO TEST-KONVERTERES
060300     IF KONVERTERES-IKKE
060400        MOVE NAVN IN HOBTD203-IO
060500          TO KUNDE-NAVN IN HOBM016-OUTPUT
060600     ELSE
060700        PERFORM 261-KONV-K-NAVN-TIL-STOR-SMAA
060800     END-IF
060900
061000     MOVE BRUGERNR IN HOBM016-INPUT
061100       TO BRUGERNR IN hobm016-output
061200
061300*    FIND CPRNR OG REFNR
061400*TBS START
061500     MOVE REFNR    IN HOBTD203-IO
061600*TBS END
061700       TO REFNR    IN hobm016-output
061800
061900     IF CPRNR-N    IN HOBTB204 OR CPRNR IN HOBTB204 = 0
062000        MOVE 0 TO FODSELS-DATO
062100                           IN hobm016-output
062200        MOVE 0 TO BRUGERS-CPRNR
062300                           IN hobm016-output
062400*TBS START
062500        MOVE KUNDE-TYP-KD  IN HOBTD203-IO
062600*TBS END
062700          TO KUNDE-TYP-KD  IN hobm016-output
062800             PORTAL-TYP-KD IN HOBM016-OUTPUT
062900     ELSE
063000        MOVE CPRNR         IN HOBTB204
063100          TO BRUGERS-CPRNR IN hobm016-output
063200*TBS START
063300        MOVE KUNDE-TYP-KD  IN HOBTD203-IO
063400*TBS END
063500          TO KUNDE-TYP-KD  IN hobm016-output
063600             PORTAL-TYP-KD IN HOBM016-OUTPUT
063700
063800        MOVE 'DATO'                      TO BDSDFUNC
063900        MOVE '39'                        TO BDSDFDT1
064000
064100        CALL 'BDSDATO' USING BDSDATOC WS-DATO-NUM
064200
064300        IF NOT BDSDATO-OK
064400           MOVE 'CALLFEJL - BDSDATO'
064500             TO MEDD-TEKST1   IN HOBM016-PARM
064600           SET FUNK-CALL-FEJL IN HOBMF138-PARM TO TRUE
064700
064800           MOVE BDSDFUNC
064900             TO KALD-FUNKTION IN HOBMF138-PARM
065000           MOVE '250-LAES-HOBTB204 A'
065100             TO KALDENDE-SECTION  IN HOBMF138-PARM
065200           MOVE 'BDSDATO'
065300             TO KALD-PRG      IN HOBMF138-PARM
065400           MOVE BDSDRETC
065500             TO KALD-KD-X     IN HOBMF138-PARM
065600           MOVE 'BDSDATO GIVER FEJL'
065700             TO KALD-MEDD1    IN HOBMF138-PARM
065800           MOVE WS-DATO-NUM
065900             TO KALD-MEDD2    IN HOBMF138-PARM
066000           MOVE BDSDATOC
066100             TO KALD-PARM     IN HOBMF138-PARM
066200
066300           SET ALVORLIG-FEJL    IN HOBMF138-PARM TO TRUE
066400           PERFORM 790-KALD-FEJL-MEDMOD
066500           SET STATU-SYSTEMFEJL IN HOBM016-PARM TO TRUE
066600           PERFORM 900-AFSLUTNING
066700        END-IF
066800
066900        MOVE 'ALDER'           TO BDSDFUNC
067000        MOVE '56'              TO BDSDFDT1
067100        MOVE '39'              TO BDSDFDT2
067200        CALL 'BDSDATO' USING BDSDATOC,
067300                           CPRNR IN HOBTB204,
067400                           WS-DATO-NUM,
067500                           FORSKEL-AAR,
067600                           FORSKEL-DAGE
067700
067800        IF NOT BDSDATO-OK
067900           MOVE CPRNR IN HOBTB204 TO WS-CPRNR
068000           MOVE FORSKEL-AAR  TO TEMP-FORSKEL-AAR
068100           MOVE FORSKEL-DAGE TO TEMP-FORSKEL-DAGE
068200           MOVE 'CALLFEJL - BDSDATO'
068300             TO MEDD-TEKST1   IN HOBM016-PARM
068400           SET FUNK-CALL-FEJL IN HOBMF138-PARM TO TRUE
068500
068600           MOVE BDSDFUNC
068700             TO KALD-FUNKTION IN HOBMF138-PARM
068800           MOVE '250-LAES-HOBTB204 A'
068900             TO KALDENDE-SECTION  IN HOBMF138-PARM
069000           MOVE 'BDSDATO'
069100             TO KALD-PRG      IN HOBMF138-PARM
069200           MOVE BDSDRETC
069300             TO KALD-KD-X     IN HOBMF138-PARM
069400           MOVE 'BDSDATO GIVER FEJL'
069500             TO KALD-MEDD1    IN HOBMF138-PARM
069600           STRING WS-CPRNR DELIMITED BY SIZE
069700                  '/' DELIMITED BY SIZE
069800                  WS-DATO-NUM DELIMITED BY SIZE
069900                  '/' DELIMITED BY SIZE
070000                  TEMP-FORSKEL-AAR DELIMITED BY SIZE
070100                  '/' DELIMITED BY SIZE
070200                  TEMP-FORSKEL-DAGE DELIMITED BY SIZE
070300             INTO KALD-MEDD2    IN HOBMF138-PARM
070400           END-STRING
070500           MOVE BDSDATOC
070600             TO KALD-PARM     IN HOBMF138-PARM
070700
070800           SET ALVORLIG-FEJL    IN HOBMF138-PARM TO TRUE
070900           PERFORM 790-KALD-FEJL-MEDMOD
071000           SET STATU-SYSTEMFEJL IN HOBM016-PARM TO TRUE
071100           PERFORM 900-AFSLUTNING
071200        END-IF
071300
071400        IF FORSKEL-AAR < 18
071500           MOVE 00010000 TO FODSELS-DATO  IN
071600                            hobm016-output
071700        ELSE
071800           MOVE 00000000 TO FODSELS-DATO  IN
071900                            hobm016-output
072000        END-IF
072100*      OVENSTÅENDE KODE ER IKKE SLETTET, DA PLANEN ER AT TAGE DET
072200*      BRUG IGEN, BARE MED EN MYNDIG_KD ISTEDET FOR MISBRUG AF
072300*      FELTET FODSELS-DATO
072400
072500*      OMFORM CPRNR TIL FØDSELSDATO I FORMATET YYYYMMDD
072600
072700        MOVE "FORMAT"  TO BDSDFUNC IN BDSDATOC
072800        MOVE "56"      TO BDSDFDT1 IN BDSDATOC
072900        MOVE "39"      TO BDSDFDT2 IN BDSDATOC
073000        MOVE CPRNR IN HOBTB204
073100          TO WS-CPRNR
073200        MOVE WS-CPRNR
073300          TO WS-CPR-COMP3
073400
073500        CALL "BDSDATO" USING BDSDATOC,
073600                               WS-CPR-COMP3
073700                               WS-FODSELSDAG
073800        END-CALL
073900        IF BDSDATO-OK
074000           MOVE WS-FODSELSDAG TO FODSELS-DATO
074100                              IN hobm016-output
074200        END-IF
074300        IF NOT BDSDATO-OK
074400          MOVE 'CALLFEJL - BDSDATO'
074500            TO MEDD-TEKST1   IN HOBM016-PARM
074600          SET FUNK-CALL-FEJL IN HOBMF138-PARM TO TRUE
074700
074800          MOVE BDSDFUNC
074900            TO KALD-FUNKTION IN HOBMF138-PARM
075000          MOVE 'OMFORM CPR TIL DATO'
075100            TO KALDENDE-SECTION  IN HOBMF138-PARM
075200          MOVE 'BDSDATO'
075300            TO KALD-PRG      IN HOBMF138-PARM
075400          MOVE BDSDRETC
075500            TO KALD-KD-X     IN HOBMF138-PARM
075600          MOVE 'BDSDATO GIVER FEJL'
075700            TO KALD-MEDD1    IN HOBMF138-PARM
075800          MOVE BDSDATOC
075900            TO KALD-PARM     IN HOBMF138-PARM
076000
076100          SET ALVORLIG-FEJL    IN HOBMF138-PARM TO TRUE
076200          PERFORM 790-KALD-FEJL-MEDMOD
076300          SET STATU-SYSTEMFEJL IN HOBM016-PARM TO TRUE
076400          PERFORM 900-AFSLUTNING
076500        END-IF
076600     END-IF
076700
076800     MOVE BORS-HANDEL-KD     IN HOBTB204
076900       TO BORS-HANDEL-KD     IN hobm016-output
077000     MOVE MARKED-DYBDE-KD    IN HOBTB204
077100       TO MARKED-DYBDE-KD    IN hobm016-output
077200     MOVE REAL-TID-KURS-KD   IN HOBTB204
077300       TO REAL-TID-KURS-KD   IN hobm016-output
077400     MOVE BORS-SPAER-KD      IN HOBTB204
077500       TO BORS-SPAER-KD      IN hobm016-output
077600     MOVE UDL-BORS-AFTALE-KD IN HOBTB204
077700       TO UDL-BORS-AFTALE-KD IN hobm016-output
077800     MOVE GMS-AFTALE-KD      IN HOBTB204
077900       TO GMS-AFTALE-KD      IN hobm016-output
078000*TBS START
078100     MOVE TILH-REGNR         IN HOBTD203-IO
078200*TBS END
078300       TO TILH-REGNR         IN hobm016-output
078400*TBS START
078500     MOVE TEST-LEV-KD        IN HOBTD203-IO
078600*TBS END
078700       TO TEST-LEV-KD        IN hobm016-output
078800*TBS START
078900     MOVE PBS-INFO-KD        IN HOBTD203-IO
079000*TBS END
079100       TO PBS-INFO-KD        IN hobm016-output
079200*TBS START
079300     MOVE TILH-KONTOR        IN HOBTD203-IO
079400*TBS END
079500       TO TILH-KONTOR        IN hobm016-output
079600*TBS START
079700     MOVE AUTO-GODK-BRUGERNR IN HOBTD203-IO
079800*TBS END
079900       TO AUTO-GODK-BRUGERNR IN hobm016-output
080000*TBS START
080100     MOVE KUNDE-GRPNR        IN HOBTD203-IO
080200*TBS END
080300       TO KUNDE-GRPNR        IN hobm016-output
080400     .
080500*-----------------------------------------------------------------
080600 260-KONV-NAVN-TIL-STOR-SMAA SECTION.
080700*-----------------------------------------------------------------
080800     MOVE NAVN IN HOBTB204 TO KONV-LINIE-STORE IN KISM505M-PARM
080900     MOVE WS-PROGRAMNAVN   TO HOVED-PROGRAM    IN KISM000I-WORK
081000     MOVE 'KONV32'         TO FUNKTIONS-KODE   IN KISM000I-WORK
081100
081200     CALL 'KISM505M' USING KISM000I-WORK
081300                           KISM505M-PARM
081400
081500     IF STATUS-TYPE IN STATUS-AREAL IN KISM000I-WORK = 'INFO' AND
081600        STATUS-KODE IN STATUS-AREAL IN KISM000I-WORK = 'OK'
081700        MOVE KONV-LINIE-STORE-SMAA IN KISM505M-OUTPUT
081800          TO BRUGER-NAVN IN hobm016-output
081900     ELSE
082000        MOVE NAVN IN HOBTB204
082100          TO BRUGER-NAVN IN hobm016-output
082200     END-IF
082300     .
082400*-----------------------------------------------------------------
082500 261-KONV-K-NAVN-TIL-STOR-SMAA SECTION.
082600*-----------------------------------------------------------------
082700*TBS START
082800     MOVE NAVN IN HOBTD203-IO TO KONV-LINIE-STORE
082900                              IN KISM505M-PARM
083000*TBS END
083100     MOVE WS-PROGRAMNAVN   TO HOVED-PROGRAM    IN KISM000I-WORK
083200     MOVE 'KONV32'         TO FUNKTIONS-KODE   IN KISM000I-WORK
083300
083400     CALL 'KISM505M' USING KISM000I-WORK
083500                           KISM505M-PARM
083600
083700     IF STATUS-TYPE IN STATUS-AREAL IN KISM000I-WORK = 'INFO' AND
083800        STATUS-KODE IN STATUS-AREAL IN KISM000I-WORK = 'OK'
083900        MOVE KONV-LINIE-STORE-SMAA IN KISM505M-OUTPUT
084000          TO KUNDE-NAVN IN hobm016-output
084100     ELSE
084200*TBS START
084300        MOVE NAVN IN HOBTD203-IO
084400*TBS END
084500          TO KUNDE-NAVN IN hobm016-output
084600     END-IF
084700     .
084800*-----------------------------------------------------------------
084900 270-UDFYLD-LOG-I-SUPPORT-LOG SECTION.
085000*-----------------------------------------------------------------
085100     IF LOG-TRANS-KD-NOT-N  IN HOBTB320 AND
085200        LOG-SLUT-DATO-NOT-N IN HOBTB320
085300        MOVE 'KLOKKEN' TO BDSDFUNC
085400        MOVE 39        TO BDSDFDT1
085500        MOVE 91        TO BDSDFKL1
085600
085700        CALL 'BDSDATO' USING BDSDATOC WS-DAGSDATO WS-TID
085800
085900        MOVE LOG-SLUT-DATO IN HOBTB320 TO WS-DB2DATO
086000        MOVE CORR WS-DB2DATO           TO WS-DB2DATO-FORMAT
086100
086200        IF LOG-TRANS-KD IN HOBTB320 = 'J' AND
086300           WS-DB2DATO-FORMAT    NOT < WS-DAGSDATO
086400           MOVE 'J'  TO LOG-I-SUPPORT-LOG IN
086500                                 hobm016-output
086600        ELSE
086700           MOVE 'N'  TO LOG-I-SUPPORT-LOG IN
086800                                 hobm016-output
086900        END-IF
087000     ELSE
087100        MOVE 'N'  TO LOG-I-SUPPORT-LOG IN
087200                              hobm016-output
087300     END-IF
087400     .
087500*-----------------------------------------------------------------
087600 280-UDFYLD-LDAP-UID SECTION.
087700*-----------------------------------------------------------------
087800     STRING 'HOB'                    DELIMITED BY SIZE
087900            BANKNR   IN HOBM016-INPUT DELIMITED BY SIZE
088000            KUNDENR  IN HOBM016-INPUT DELIMITED BY SIZE
088100            BRUGERNR IN HOBM016-INPUT DELIMITED BY SIZE
088200       INTO LDAP-UID IN hobm016-output
088300     END-STRING
088400     .
088500*-----------------------------------------------------------------
088600 300-LOKAL-BRUGER SECTION.
088700*-----------------------------------------------------------------
088800* Find ud af om bruger er lokal bruger (Ingen disp. fuldmagter)
088900*-----------------------------------------------------------------
089000
089100     INITIALIZE HOBMT261-PARM
089200     SET FUNK-TJEK-LOKAL-FULDM in HOBMT261-PARM TO TRUE
089300     MOVE BANKNR   IN HOBM016-INPUT
089400       TO BANKNR   IN HOBTD261-IO IN HOBMT261-PARM
089500     MOVE KUNDENR  IN HOBM016-INPUT
089600       TO KUNDENR  IN HOBTD261-IO IN HOBMT261-PARM
089700     MOVE BRUGERNR IN HOBM016-INPUT
089800       TO BRUGERNR IN HOBTD261-IO IN HOBMT261-PARM
089900
090000     CALL 'HOBMT261' USING HOBMT261-PARM
090100
090200     IF  STATU-OK          IN HOBMT261-PARM
090300*        fuldmagter fundet - så han er IKKE lokal bruger !
090400         move 'N'
090500           to BRUGER-ER-LOKAL-BRUGER
090600              in hobm016-output
090700     else
090800*        ingen fuldmagter - så han er lokal bruger !
090900         move 'J'
091000           to BRUGER-ER-LOKAL-BRUGER
091100              in hobm016-output
091200     end-if
091300     .
091400*-----------------------------------------------------------------
091500 310-TJEK-IP-WHITELIST SECTION.
091600*-----------------------------------------------------------------
091700     INITIALIZE HOBMF612-PARM
091800
091900     SET FUNK-KUNDE-WHITELISTET IN HOBMF612-PARM TO TRUE
092000     MOVE BANKNR    IN HOBM016-INPUT
092100       TO BANKNR    IN IO-TABLE IN HOBMF612-PARM
092200     MOVE KUNDENR   IN HOBM016-INPUT
092300       TO KUNDENR   IN IO-TABLE IN HOBMF612-PARM
092400     MOVE BRUGERNR  IN HOBM016-INPUT
092500       TO BRUGERNR  IN IO-TABLE IN HOBMF612-PARM
092600
092700     CALL 'HOBMF612' USING HOBMF612-PARM
092800     END-CALL
092900
093000     EVALUATE TRUE
093100        WHEN STATU-OK   IN HOBMF612-PARM
093200             MOVE 'B' TO HARW-BINDING-AKTIV-JN IN hobm016-output
093300
093400        WHEN STATU-FEJL IN HOBMF612-PARM
093500             MOVE 'N' TO HARW-BINDING-AKTIV-JN IN hobm016-output
093600
093700        WHEN OTHER
093800           MOVE BDSISTDI-AREAL  IN HOBMF612-PARM
093900             TO RETURKODE-AREAL IN HOBM016-PARM
094000
094100           SET FUNK-CALL-FEJL IN HOBMF138-PARM TO TRUE
094200           MOVE '400-TJEK-WHITE-LISTED'
094300             TO KALDENDE-SECTION IN HOBMF138-PARM
094400           MOVE FUNKTION      IN HOBMF612-PARM
094500             TO KALD-FUNKTION IN HOBMF138-PARM
094600           MOVE 'HOBMF612'
094700             TO KALD-PRG      IN HOBMF138-PARM
094800           MOVE STATU-KD      IN HOBMF612-PARM
094900             TO KALD-KD       IN HOBMF138-PARM
095000           MOVE MEDD-TEKST1   IN HOBMF612-PARM
095100             TO KALD-MEDD1    IN HOBMF138-PARM
095200           MOVE MEDD-TEKST2   IN HOBMF612-PARM
095300             TO KALD-MEDD2    IN HOBMF138-PARM
095400           MOVE HOBMF612-PARM
095500             TO KALD-PARM     IN HOBMF138-PARM
095600
095700           IF STATU-FEJL IN HOBMF612-PARM
095800              SET STATU-SYSTEMFEJL IN HOBM016-PARM TO TRUE
095900              SET ALVORLIG-FEJL    IN HOBMF138-PARM TO TRUE
096000           ELSE
096100              SET INGEN         IN HOBMF138-PARM TO TRUE
096200           END-IF
096300           PERFORM 790-KALD-FEJL-MEDMOD
096400     END-EVALUATE
096500     .
096600*-----------------------------------------------------------------
096700 320-FIND-DANID-STATUS SECTION.
096800*-----------------------------------------------------------------
096900     MOVE DANID-AKTIV-KD  IN HOBTB204
097000       TO DANID-STATUS
097100
097200     MOVE '19000101'
097300          TO DANID-DEADLINE
097400     MOVE '19000101'
097500          TO DANID-A-START
097600     .
097700*-----------------------------------------------------------------
097800 331-TJEK-SEPA-DD-NY SECTION.
097900*-----------------------------------------------------------------
098000* TJEKKER OM KUNDEN ER SEPA DD KUNDE
098100*-----------------------------------------------------------------
098200
098300     MOVE 'N' TO SEPA-DD-KD IN hobm016-output
098400
098500     INITIALIZE HOBD402-PARM
098600
098700     MOVE BANKNR  IN HOBM016-INPUT
098800       TO BANKNR  IN HOBD402-PARM
098900     MOVE KUNDENR IN HOBM016-INPUT
099000       TO KUNDENR IN HOBD402-PARM
099100
099200     MOVE 1 TO BDSMFJL-I-PRG-POS
099300     PERFORM INC-KALD-HOBD402
099400
099500     IF STATU-OK IN HOBD402-PARM
099600        MOVE 'J' TO SEPA-DD-KD IN HOBM016-OUTPUT
099700     END-IF
099800     .
099900*-----------------------------------------------------------------
100000 350-FIND-BEH-SPOR-KD SECTION.
100100*-----------------------------------------------------------------
100200* find behandlingssporkode (alm. kunde, Mega kunde eller ATP)
100300*-----------------------------------------------------------------
100400
100500     IF KUNDE-TYP-KD IN HOBTD203-IO = 'E'
100600        INITIALIZE EDIM063-PARM
100700
100800        MOVE BANKNR IN HOBM016-INPUT
100900          TO BANKNR IN EDIM063-PARM
101000        MOVE KUNDENR IN HOBM016-INPUT
101100          TO KUNDENR IN EDIM063-PARM
101200        IF MEDIENR IN HOBM016-INPUT = 3
101300           MOVE 'MBT'
101400             TO AFS-KANAL-ID IN EDIM063-PARM
101500        ELSE
101600           MOVE 'NBT'
101700             TO AFS-KANAL-ID IN EDIM063-PARM
101800        END-IF
101900
102000     MOVE 2 TO BDSMFJL-I-PRG-POS
102100        PERFORM INC-KALD-EDIM063
102200        IF STATU-OK IN EDIM063-PARM
102300           MOVE BEH-SPOR-KD IN EDIM063-PARM
102400             TO BEH-SPOR-KD IN HOBM016-OUTPUT
102500        ELSE
102600           MOVE 'N'
102700             TO BEH-SPOR-KD IN HOBM016-OUTPUT
102800        END-IF
102900     ELSE
103000        MOVE 'N'
103100          TO BEH-SPOR-KD IN HOBM016-OUTPUT
103200     END-IF
103300     .
103400******************************************************************
103500 790-KALD-FEJL-MEDMOD SECTION.
103600******************************************************************
103700      SET STATU-SYSTEMFEJL  IN HOBM016-PARM TO TRUE
103800     MOVE IDENT-AREAL       IN HOBM016-PARM
103900       TO IDENT-AREAL       IN HOBMF138-PARM
104000     MOVE WS-PROGRAMNAVN
104100       TO KALDENDE-PROGRAM  IN HOBMF138-PARM
104200     MOVE FUNKTION          IN HOBM016-PARM
104300       TO KALDENDE-FUNKTION IN HOBMF138-PARM
104400     MOVE FEJL-ID           IN HOBM016-PARM
104500       TO FEJL-ID           IN HOBMF138-PARM
104600
104700     CALL 'HOBMF138' USING HOBMF138-PARM
104800
104900     MOVE FEJL-ID  IN HOBMF138-PARM
105000       TO FEJL-ID  IN HOBM016-PARM
105100     .
105200*-----------------------------------------------------------------
105300 900-AFSLUTNING SECTION.
105400*-----------------------------------------------------------------
105500     GOBACK.
105600* INCLUDER RUTINER TIL STANDARD FEJLBEHANDLING *******************
105700     COPY HOBIREST.
105800     COPY HOBD402K.
105900     COPY EDIM063K.
